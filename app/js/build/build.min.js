var app=angular.module("bugtracker",["ui.router","ngResource","ngRoute","ui.bootstrap","ngDragDrop"]);app.config(function(a,b){b.otherwise("/"),a.state("board",{url:"/",templateUrl:"templates/views/board.html",controller:"BoardCtrl",resolve:{tickets:function(a){return a.query().$promise}}}).state("board.panel",{url:"panel/:id",templateUrl:"templates/views/edit-ticket.html",controller:"EditTicketCtrl",resolve:{ticket:function(a,b){return a.get({_id:b.id}).$promise}}}).state("table-view",{url:"/table-view",templateUrl:"templates/views/table-view.html",controller:"TableCtrl",resolve:{tickets:function(a){return a.query().$promise}}}).state("add-ticket",{url:"/add-ticket",templateUrl:"templates/views/add-ticket.html",controller:"AddTicketCtrl"}).state("add-author",{url:"/add-author",templateUrl:"templates/views/add-author.html",controller:"AddAuthorCtrl"}).state("edit-ticket",{url:"/edit-ticket/:id",templateUrl:"templates/views/edit-ticket.html",controller:"EditTicketCtrl",resolve:{ticket:function(a,b){return a.get({_id:b.id}).$promise}}})}),app.controller("AddAuthorCtrl",function(a,b,c,d,e){a.postAuthorToDb=function(a){e.save(a).$promise.then(function(){c.go("board")})}}),app.controller("AddTicketCtrl",function(a,b,c,d,e,f,g,h){a.getAuthors=function(a){return h.search({q:JSON.stringify({name:{$regex:a}})}).$promise.then(function(a){var b=[];return angular.forEach(a,function(a){this.push(a.name+" "+a.surname)},b),b})},a.ticket={createdDate:new Date,status:"todo",comments:[],trackedTimeArr:[]},a.postTicketToDb=function(a){e.query({s:{id:-1},l:1}).$promise.then(function(b){a.id=b.length?b[0].id+1:1,e.save(a).$promise.then(function(){c.go("board")})})}}),app.controller("BoardCtrl",function(a,b,c,d,e,f){a.tickets=c,a.addCol=function(a){e.go("board.panel",{id:a._id})},a.statuses=["todo","inprogress","resolved"],a.dropColumn=function(b,c){angular.forEach(a.tickets,function(a){a.id===b.id&&(a.status=c,d.update({_id:a._id},a).$promise.then(function(){e.transitionTo("board",f,{reload:!0,inherit:!1,notify:!0})}))})}}),app.controller("EditTicketCtrl",function(a,b,c,d,e,f){a.ticket=f,a.modalShown=!1,a.toggleModal=function(){a.modalShown=!a.modalShown},a.edit=function(a){d.update({_id:a._id},a).$promise.then(function(){e.transitionTo("board",b,{reload:!0,inherit:!1,notify:!0})})},a.remove=function(a){d.delete({_id:a._id}).$promise.then(function(){e.transitionTo("board",b,{reload:!0,inherit:!1,notify:!0})})},a.addComment=function(a){a.date=new Date,f.comments.push(a),d.update({_id:b.id},f).$promise.then(function(){e.transitionTo(e.current,b,{reload:!0,inherit:!1,notify:!0})})}}),app.controller("TableCtrl",function(a,b){a.tickets=b,a.templateObj={id:'<div ng-bind="cell"></div>',_id:'<div ><a ui-sref="edit-ticket({id: cell})">edit</a></div>',assignee:'<div ng-bind="cell"></div>',comments:'<div ng-repeat="cellValue in cell">Author:<div class="table-cell" ng-bind="cellValue.author"></div>Comment:<div class="table-cell" ng-bind="cellValue.comment"></div>Date:<div class="table-cell" ng-bind="cellValue.date | date:dd/MM/yyyy"></div>',createdDate:'<div ng-bind="cell | date:dd/MM/yyyy"></div>',trackedTimeArr:'<div ng-repeat="cellValue in cell"><div class="table-cell" ng-bind="cellValue.author"></div><div class="table-cell" ng-bind="cellValue.name"></div><div class="table-cell" ng-bind="cellValue.time | minuteFilter"></div></div>',priority:'<div ng-bind="cell"></div>',description:'<div ng-bind="cell"></div>',title:'<div ng-bind="cell"></div>',type:'<div ng-bind="cell"></div>',status:'<div ng-bind="cell"></div>'}}),app.directive("modalDialog",function(){return{restrict:"E",scope:{show:"="},replace:!0,transclude:!0,link:function(a,b,c){a.dialogStyle={},c.width&&(a.dialogStyle.width=c.width),c.height&&(a.dialogStyle.height=c.height),a.hideModal=function(){a.show=!1}},templateUrl:"templates/partials/modal.html"}}),app.directive("btTableCell",function(a){return{restrict:"A",scope:{cell:"=cellData",buildCell:"&"},replace:!0,link:function(b,c){c.html(b.buildCell()),a(c.contents())(b)},template:"<div></div>"}}),app.directive("btTableView",function(){return{restrict:"EA",scope:{items:"=data",template:"="},templateUrl:"templates/partials/table.html",transclude:!0,link:function(a){var b=[];angular.forEach(a.items[0],function(a,b){this.push({colName:b,valid:!0})},b),a.columnsHeaders=b;var c=[];a.selected=function(b){if(-1!=c.indexOf(b)){var d=c.indexOf(b);d>-1&&c.splice(d,1)}else c.push(b);a.selectedColumns=c},a.orderByField="id",a.reverseSort=!1,a.order=function(b,c){a.header=b,a.reverseSort=c},a.order("-id",!1),a.totalItems=a.items.length,a.currentPage=1,a.numPerPage=5,a.setPage=function(b){a.currentPage=b},a.paginate=function(b){var c,d,e;return c=(a.currentPage-1)*a.numPerPage,d=c+a.numPerPage,e=a.items.indexOf(b),e>=c&&d>e}}}}),app.directive("btTicket",function(){return{restrict:"A",templateUrl:"templates/partials/ticket.html"}}),app.directive("btTimeTracker",function(a,b,c){return{restrict:"EA",scope:{ticket:"=data"},replace:!0,templateUrl:"templates/partials/time-tracker.html",link:function(d){d.trackedData={},d.trackedTime="",d.totalTime=function(a){var b={days:parseInt(a.match(/ *(\d+)([d])/gm)||0),hours:parseInt(a.match(/ *(\d+)([h])/gm)||0),min:parseInt(a.match(/ *(\d+)([m])/gm)||0)},c=60*b.days*8+60*b.hours+b.min,e=parseInt(c/480),f=parseInt((c-60*e*8)/60),g=parseInt(c-(60*e*8+60*f));return d.trackedData.time=c,e+" days "+f+" hours "+g+" min "},d.trackedData.author=d.ticket.assignee,d.trackedData.date=new Date,d.addTrackedTime=function(e){e.trackedTimeArr.push(d.trackedData),a.update({_id:e._id},e).$promise.then(function(){c.transitionTo(c.current,b,{reload:!0,inherit:!1,notify:!0})})}}}}),app.filter("minuteFilter",function(){return function(a,b){switch(b){case"days":return parseInt(a/60/8)+" days";case"hours":return parseInt(a/60)+" hours";case"minutes":return a+" minutes";default:var c=parseInt(a/480),d=parseInt((a-60*c*8)/60),e=parseInt(a-(60*c*8+60*d));return c+" days "+d+" hours "+e+" min "}}}),app.filter("reorderFilter",function(){return function(a,b){return Array.prototype.move=function(a,b){if(b>=this.length)for(var c=b-this.length;c--+1;)this.push(void 0);return this.splice(b,0,this.splice(a,1)[0]),this},a.move(0,b),a}}),app.factory("Author",function(a,b,c){return a(b.authorUrl,{_id:"@Id",apiKey:b.apiKey},{get:{method:"GET",isArray:!0,transformResponse:c.transformResponseGet},search:{method:"GET",isArray:"true",params:{q:":@q"},url:b.authorUrl,transformResponse:c.transformResponse}})}),app.constant("constant",{url:"https://api.mongolab.com/api/1/databases/bugsdemodb/collections/bugscollection/:_id",authorUrl:"https://api.mongolab.com/api/1/databases/bugsdemodb/collections/authors/:_id",apiKey:"aQulivByDLdq_F1mhTgUSXG4eYLJJ8rs"}),app.factory("Ticket",function(a,b,c){return a(b.url,{_id:"@Id",apiKey:b.apiKey},{update:{method:"PUT",transformRequest:c.transformRequest},get:{method:"GET",isArray:!1,transformResponse:c.transformResponseGet},query:{method:"GET",isArray:!0,transformResponse:c.transformResponse}})}),app.service("transformMongoService",function(){return{transformRequest:function(a){return delete a._id,angular.toJson(a)},transformResponseGet:function(a){var b=angular.fromJson(a);return b._id=b._id.$oid,b},transformResponse:function(a){var b=angular.fromJson(a),c=[];return angular.forEach(b,function(a){a._id=a._id.$oid,this.push(a)},c),c}}});